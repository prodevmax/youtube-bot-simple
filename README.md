# YouTube Bot Simple — Telegram загрузчик YouTube (yt-dlp)

Минимальный Telegram‑бот для скачивания видео/аудио с YouTube с помощью `yt-dlp`. Без БД и DI, очередь в памяти, простой конфиг через `.env`.

## Возможности
- Приём ссылок YouTube (включая Shorts) в ЛС бота.
- Варианты на выбор: 360p, HD 720p, Full HD 1080p, 2K 1440p, аудио MP3.
- Очередь задач и параллельные загрузки (по умолчанию 2 воркера).
- Ограничение размера отправляемого файла (по умолчанию 45 МБ).
- Устойчивость к сетевым ошибкам: ретраи, `--force-ipv4`, повторная попытка без прокси.
- Очистка скачанных файлов по TTL.

Ограничения MVP: нет БД, метрик, прокси‑ротации, прогресса в реальном времени и HTTP‑раздачи больших файлов.

## Требования
- Go 1.23+
- `yt-dlp` и `ffmpeg` установлены в системе и доступны в `$PATH` (или заданы явные пути).

Установка утилит:
- macOS: `brew install yt-dlp ffmpeg`
- Ubuntu/Debian: `sudo apt-get install -y ffmpeg` и `pipx install yt-dlp` или `pip install yt-dlp`

Проверьте:
```
yt-dlp --version
ffmpeg -version
```

## Быстрый старт
1) Скопируйте пример окружения и задайте токен бота:
```
cp .env.example .env
nano .env
```

2) Установите зависимости и запустите:
```
go mod tidy
make run        # или: go run ./cmd/bot
```

3) В Telegram найдите вашего бота, отправьте ссылку на видео, выберите вариант (360p/720p/1080p/1440p/MP3) и дождитесь ответа.

## Конфигурация (ENV)
- `TELEGRAM_TOKEN` — токен бота (обязательно)
- `DOWNLOAD_DIR` — директория загрузок (default `./downloads`)
- `CONCURRENCY` — число воркеров (default `2`)
- `QUEUE_CAPACITY` — размер буфера очереди (default `100`)
- `MAX_FILE_MB` — лимит размера отправляемого файла (default `45`)
- `CLEANUP_TTL_HOURS` — удаление файлов старше N часов (default `12`, `0` — выключить)
- `CMD_TIMEOUT_SEC` — таймаут процесса `yt-dlp` (default `600`)
- `HTTP_PROXY` — одиночный прокси (опционально)
- `YTDLP_PATH`, `FFMPEG_PATH` — явные пути к бинарникам (опционально)

## Команды
```
make run      # запуск бота
make build    # сборка бинарника в bin/bot
make tidy     # go mod tidy
make test     # запустить тесты (включая интеграционный)
```

## Как это работает (коротко)
- Сообщение с URL → бот валидирует ссылку и отвечает инлайн‑кнопками.
- Нажатие кнопки → формируется задача (URL, вариант) и ставится в очередь.
- Воркер запускает `yt-dlp` с нужным форматом, ждёт завершения, проверяет размер и отправляет файл в чат.
- При превышении лимита размера отправляется сообщение с рекомендацией выбрать 360p или MP3.

## Трейблшутинг
- Ошибка DNS/прокси вида: `nodename nor servname provided`:
  - Уберите `HTTP_PROXY` из `.env` или проверьте его корректность.
  - Проверьте сеть: `nslookup youtube.com`, `curl -I https://www.youtube.com`.
  - Запустите вручную: `yt-dlp --force-ipv4 https://youtu.be/<id>`.
- `Файл слишком большой` — Telegram ограничивает размер загружаемых файлов. Используйте 360p или MP3.
- Обновите `yt-dlp`: `yt-dlp -U`.
- Очистите кэш Go при странных ошибках сборки: `go clean -cache -modcache -testcache`.

## Безопасность и приватность
- Не коммитьте `.env` (уже в `.gitignore`).
- Скачанные файлы удаляются по TTL, настраивается `CLEANUP_TTL_HOURS`.
- Логи не содержат лишних персональных данных.

## Дорожная карта
- Прогресс‑уведомления (парсинг stdout `yt-dlp`).
- HTTP‑раздача больших файлов (временные ссылки).
- Ротация прокси и гибкая политика ретраев.
- Метрики Prometheus и дашборды Grafana.
- История запросов/пользователей в БД, квоты, антиспам.

---

Если нужен Docker‑образ, прогресс в чате или раздача больших файлов — дайте знать, добавим следующими итерациями.
