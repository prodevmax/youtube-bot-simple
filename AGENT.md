# AGENT: Обзор функционала и архитектуры

Документ агрегирует всё ключевое знание о функциональности и архитектуре проекта:
- «Упрощённый» проект: `youtube-bot-simple` — минимальный монолит без БД/DI/метрик, очередь в памяти, прямой вызов yt-dlp.

Цель — дать разработчику и инструментам (агентам) компактную картину текущего состояния, отличий и дорожной карты.

## 1) Упрощённый проект: youtube-bot-simple

### Функциональность (MVP)
- Принимает ссылку на YouTube (включая Shorts) в личных сообщениях.
- Отвечает инлайн-кнопками: «Видео 360p», «Видео 720p», «Аудио MP3».
- По нажатию — создаёт задачу на загрузку, ставит в очередь, скачивает через `yt-dlp` и отправляет файл в чат.
- Проверяет размер итогового файла: при превышении лимита (по умолчанию 45 МБ) — сообщает пользователю и предлагает выбрать другой вариант (360p/MP3).
- Обрабатывает несколько параллельных загрузок (по умолчанию 2) с буферизированной очередью.
- Фоновая очистка скачанных файлов старше `CLEANUP_TTL_HOURS`.

Ограничения MVP:
- Нет БД, нет DI, нет метрик, нет прокси-ротации, нет прогресса в реальном времени, нет веб-раздачи больших файлов.

### Архитектура (монолит, один процесс)
- Входная точка: `cmd/bot/main.go` — загрузка конфигурации, создание бота, стора, очереди, раннера; запуск воркеров и graceful shutdown.
- Telegram: `internal/telegram/bot.go` — обработка `/start`, `/help`, текстовых сообщений с ссылками, колбэков; постановка задач в очередь; отправка результата.
- Очередь: `internal/queue/queue.go` — buffered-канал + пул воркеров; `Job { ChatID, URL, Variant, RequestedAt, Attempts }`.
- Загрузка: `internal/downloader/yt_dlp.go` — сборка аргументов `yt-dlp`/`ffmpeg`, таймаут команды, определение итогового файла и его размера.
- Состояние: `internal/state/store.go` — in-memory TTL store для токенов в `callback_data` (token → URL), GC по таймеру.
- Файлы: `internal/files/fs.go` — создание директории, вычисление размера, фоновая очистка по TTL.
- Конфиг: `internal/config/config.go` — чтение ENV (+ простой `.env`), значения по умолчанию и валидация.

Поток данных:
1) Сообщение с URL → валидация → генерация временного токена → ответ с инлайн-кнопками.
2) Колбэк с `t=<token>;v=<360|720|mp3>` → извлечение URL из стора → `Job` в очередь.
3) Воркеры запускают `yt-dlp` → по результату отправляют файл (video/audio/document) либо сообщение об ошибке/лимите.

### Форматы и ключевые аргументы yt-dlp
- Видео 360p: `-f "bv*[height<=360]+ba/b[ext=mp4]/best[height<=360]" --merge-output-format mp4`
- Видео 720p: `-f "bv*[height<=720]+ba/b[ext=mp4]/best[height<=720]" --merge-output-format mp4`
- Аудио MP3: `-x --audio-format mp3`
- Общие: `-o "%(id)s_%(title).80s.%(ext)s" -P <DOWNLOAD_DIR> --no-playlist --no-progress --no-warnings --print after_move:filepath`
- Таймаут команды из `CMD_TIMEOUT_SEC`; опционально `--proxy $HTTP_PROXY`, `--ffmpeg-location $FFMPEG_PATH`.

### Конфигурация (ENV)
- `TELEGRAM_TOKEN` — обязательный.
- `DOWNLOAD_DIR` — директория скачиваний (default `./downloads`).
- `CONCURRENCY` — число воркеров (default 2).
- `QUEUE_CAPACITY` — буфер очереди (default 100).
- `MAX_FILE_MB` — лимит размера отправляемого файла (default 45).
- `CLEANUP_TTL_HOURS` — TTL очистки файлов (default 12; 0 — отключить).
- `CMD_TIMEOUT_SEC` — таймаут процесса `yt-dlp` (default 600).
- `HTTP_PROXY` — одиночный прокси (опционально).
- `YTDLP_PATH`, `FFMPEG_PATH` — явные пути (опционально).

### Зависимости
- Go 1.21+
- `github.com/go-telegram-bot-api/telegram-bot-api/v5`
- В системе установлены `yt-dlp` и `ffmpeg` (в `$PATH` или по указанным путям).

### Логика ошибок и UX
- Неверный URL → «Похоже, это не ссылка на YouTube…»
- Истёкший токен → «Кнопка устарела. Пришлите ссылку ещё раз.»
- Ошибка `yt-dlp` → «Не удалось скачать: <краткая причина>» (подробности — в логах).
- Превышение размера → «Файл слишком большой… Попробуйте 360p или MP3.»

### Безопасность и практики
- Токен Telegram хранить в `.env` (не коммитить).
- Логи без лишних подробностей о пользователях; детальные ошибки — в stderr логах процесса.
- Очистка скачиваний по TTL (уменьшает риск утечки данных на диске).

### Дорожная карта (после MVP)
- Прогресс-уведомления (парсинг stdout `yt-dlp`).
- HTTP-раздача больших файлов (ссылки с TTL).
- Прокси-ротация (список прокси, round-robin, retry).
- Метрики Prometheus, дашборды Grafana.
- Хранение истории запросов и пользователей (БД), квоты, антиспам.

### Структура каталога (simple)
- `cmd/bot/main.go`
- `internal/telegram/bot.go`
- `internal/queue/queue.go`
- `internal/downloader/yt_dlp.go`
- `internal/state/store.go`
- `internal/files/fs.go`
- `internal/config/config.go`
- `Makefile`, `.env.example`, `SPEC.md`

---

## 3) Практические рекомендации для разработки

## 3.1) Схема потоков (simple)

```
 Пользователь            Telegram API               Бот (simple)                      Очередь/Воркеры               yt-dlp/ffmpeg           Файлы
     |                         |                           |                                   |                             |                    |
     |  /start,/help/URL       |                           |                                   |                             |                    |
     |------------------------>| update                   |                                   |                             |                    |
     |                         |------------------------->| parse URL/команда                 |                             |                    |
     |                         |                           | if URL: put token->store          |                             |                    |
     |                         |                           | reply inline-кнопки               |                             |                    |
     |<------------------------| message                  |                                   |                             |                    |
     |                         | callback                 |                                   |                             |                    |
     |------------------------>|------------------------->| get token->URL                     | enqueue(Job{URL,variant})   |                    |
     |                         |                           | reply "Начинаю загрузку…"         |---------------------------->| spawn process       |
     |                         |                           |                                   |                             |   download to dir  |
     |                         |                           |                                   |<----------------------------| exit status/path    |
     |                         |                           | check size / build response       |                             |                    |
     |<------------------------| send file / message      |                                   |                             |                    |
```

Ключевые точки:
- В `callback_data` хранится только `token` и выбранный вариант (360/720/mp3); URL — в `state.Store` с TTL.
- Воркеры ограничены `CONCURRENCY`, задачи буферизуются `QUEUE_CAPACITY`.
- Ошибки и превышение размера транслируются пользователю краткими сообщениями.

## 4) Быстрый старт (simple)
- Установить `yt-dlp`, `ffmpeg`.
- Скопировать `.env.example` → `.env` и заполнить `TELEGRAM_TOKEN`.
- Запустить: `make run` или `go run ./cmd/bot`.
- Отправить боту ссылку на YouTube, затем выбрать вариант 360p/720p/MP3.

## 5) Точки расширения (simple)
- Парсинг прогресса `yt-dlp` и уведомления в чат.
- Ограничение числа задач per-user, антиспам в памяти.
- Стабилизация через повторные попытки и backoff.
- Локализация текстов, вынесение в конфиг.

---

## Чеклист релиза (simple)
- Токен Telegram в `.env` и не закоммичен; repo чист от секретов.
- Установлены `yt-dlp` и `ffmpeg`; `yt-dlp --version` и `ffmpeg -version` работают.
- `DOWNLOAD_DIR` существует и доступен для записи; настроен `CLEANUP_TTL_HOURS`.
- Локальный запуск `go run ./cmd/bot` без ошибок; бот отвечает на `/start`.
- Тестовые сценарии:
  - Ссылка на обычное видео → 360p/720p скачиваются и отправляются.
  - Ссылка на Shorts → скачивается как видео, отправляется.
  - Аудио MP3 → файл отправляется; размер в пределах `MAX_FILE_MB`.
  - Предельно большой ролик → корректное сообщение «слишком большой файл».
  - Просроченная кнопка → сообщение «Кнопка устарела…».
- Обработка 2 параллельных задач без deadlock/паник; очередь не переполняется на типовых объёмах.
- Логи чистые от PII; ошибки `yt-dlp` видны в логах, но пользователю короткие тексты.
- Makefile цели `run`/`build` работают; бинарник не коммитится (игнорируется).


Этот файл предназначен для быстрого ориентирования по проектам и как справочник для разработчиков/агентов.
