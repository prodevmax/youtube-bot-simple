# Упрощённый Telegram-бот для загрузки YouTube (yt-dlp)

Документ определяет минимальный, не переусложнённый вариант бота для разработки с нуля. Цель — максимально простая реализация, которую можно быстро запустить и постепенно расширять.

## 1. Цели и границы
- Минимум компонентов, без БД, без DI-контейнеров, без микросервисов.
- Загрузка видео/аудио по ссылке YouTube через `yt-dlp` и отправка файла пользователю в Telegram.
- Простая обработка очереди с ограничением параллелизма (в памяти).
- Надёжное поведение при ошибках, понятные сообщения пользователю.
- Лёгкая установка и локальный запуск.

Не включаем в MVP: прокси-ротацию, метрики, Grafana/Prometheus, MySQL, сложные оркестраторы, персистентность состояния, прогресс-бар в реальном времени, веб-сервер для раздачи файлов.

## 2. Пользовательские сценарии (MVP)
1) Пользователь отправляет боту ссылку на YouTube видео или шортс.
2) Бот отвечает сообщением с инлайн-кнопками: «Видео 360p», «Видео 720p», «Аудио MP3».
3) Пользователь выбирает вариант. Бот:
   - подтверждает «Начинаю загрузку…», ставит задачу в очередь;
   - после завершения — отправляет файл (если размер позволяет), либо сообщает, что файл слишком большой и предлагает другой вариант (например, аудио или 360p).
4) Команды `/start` и `/help` показывают краткую инструкцию.

Ограничения Telegram: загружать ботом можно ограниченные по размеру файлы (ориентируемся на ~50 МБ). В MVP при превышении лимита отправляем понятное сообщение и предлагаем другой формат/качество. В последующих итерациях можно добавить HTTP-раздачу крупных файлов.

## 3. Нефункциональные требования
- Простота кода и структуры, отсутствие лишних абстракций.
- Кроссплатформенность (Linux/macOS/Windows при наличии `yt-dlp` и `ffmpeg`).
- Конфигурация через переменные окружения, .env.
- Логи на английском, сообщения пользователю на русском; комментарии в коде на русском (кратко, по делу).
- Безопасность: токен бота из .env, файлы сохранять в локальную директорию с периодической очисткой.

## 4. Архитектура (упрощённая)
Компоненты одного процесса:
- Telegram Handler: получение апдейтов, парсинг сообщений, ответы, обработка callback.
- In-Memory State Store: короткоживущие записи по кнопкам (token → URL и параметры), TTL.
- Download Queue + Workers: очередь задач загрузки и пул из N воркеров (N задаётся в конфиге).
- YtDlp Runner: обёртка над вызовом `yt-dlp`/`ffmpeg` с построением команд и обработкой ошибок.
- File Store: директория для результатов загрузок; утилиты для проверки размера; плановая очистка старых файлов (опционально в MVP или как фоновой тикер).

Потоки данных:
- Message → parse URL → reply с кнопками → Callback → создать Job → очередь → worker запускает `yt-dlp` → по результату отправить файл/сообщение пользователю.

## 5. Пакетная структура (плоская и понятная)
- `cmd/bot/main.go` — точка входа, загрузка конфига, инициализация бота и очереди.
- `internal/telegram/bot.go` — обработка апдейтов, кнопок, ответы.
- `internal/state/store.go` — in-memory хранилище временного состояния (token → payload) с TTL.
- `internal/queue/queue.go` — очередь задач, воркеры, типы Job/Result.
- `internal/downloader/yt_dlp.go` — сборка и запуск команд `yt-dlp`, проверка размера, маппинг форматов.
- `internal/files/fs.go` — директория загрузок, расчёт размера, очистка по TTL.
- `internal/config/config.go` — чтение env, значения по умолчанию, валидация.

Без DI и БД. Прямое связывание зависимостей в `main.go`.

## 6. Конфигурация (ENV)
- `TELEGRAM_TOKEN` — токен бота (обязательно).
- `DOWNLOAD_DIR` — путь для сохранения файлов (по умолчанию `./downloads`).
- `YTDLP_PATH` — путь к `yt-dlp` (по умолчанию искать в `$PATH`).
- `FFMPEG_PATH` — путь к `ffmpeg` (по умолчанию искать в `$PATH`).
- `CONCURRENCY` — число параллельных загрузок (по умолчанию 2).
- `MAX_FILE_MB` — максимальный размер отправляемого файла (по умолчанию 45, чтобы иметь запас под лимиты Telegram).
- `CLEANUP_TTL_HOURS` — через сколько часов удалять файлы (по умолчанию 12, можно 0 чтобы отключить).
- `HTTP_PROXY` — опционально, если нужен одиночный прокси для `yt-dlp`.
- `CMD_TIMEOUT_SEC` — таймаут запуска `yt-dlp` (по умолчанию 600).

Пример `.env`:
```
TELEGRAM_TOKEN=123456:ABC...
DOWNLOAD_DIR=./downloads
CONCURRENCY=2
MAX_FILE_MB=45
CLEANUP_TTL_HOURS=12
CMD_TIMEOUT_SEC=600
# HTTP_PROXY=http://user:pass@host:port
```

## 7. Поведение бота
- `/start` — приветствие и инструкция: «Пришлите ссылку на YouTube, затем выберите вариант». 
- `/help` — краткая справка и ограничения.
- Сообщение с ссылкой: валидируем, создаём short-lived token в `StateStore`, отвечаем сообщением с кнопками:
  - «Видео 360p», «Видео 720p», «Аудио MP3».
  - В `callback_data` используем короткий `token` и код варианта (например, `t=<token>;v=360`), сам URL и длинные параметры храним в памяти.
- Callback: читаем `token`, достаём URL и вариант, ставим Job в очередь, отвечаем «Начинаю загрузку…». При недействительном токене — «Кнопка устарела, пришлите ссылку снова.»
- Результат:
  - Успех: отправить `sendVideo`/`sendAudio`/`sendDocument` в зависимости от формата и размера.
  - Слишком большой файл: «Файл слишком большой для отправки ботом. Попробуйте 360p или Аудио.»
  - Ошибка `yt-dlp`: «Не удалось скачать: <краткая причина>».

## 8. Очередь и параллелизм
- Простой канал (buffered) + воркеры (N=CONCURRENCY).
- Job содержит: chatID, messageID, url, kind(video|audio), quality(360|720), requestedAt, попытки.
- Worker строит команду, запускает, ждёт завершения, формирует Result.
- В MVP прогресс не транслируем в чат. Только старт/финиш. (В будущем можно парсить stdout `yt-dlp`.)

## 9. Построение команд yt-dlp
Общие параметры:
- Выходной шаблон: `-o "<DOWNLOAD_DIR>/%(id)s_%(title).80s.%(ext)s"`
- Таймаут: ограничивать на уровне контекста процесса.
- Прокси (если задан `HTTP_PROXY`): `--proxy "$HTTP_PROXY"`

Варианты:
- Видео 360p (mp4):
  - `yt-dlp -f "bv*[height<=360]+ba/b[ext=mp4]/best[height<=360]" --merge-output-format mp4 -o <...> <URL>`
- Видео 720p (mp4):
  - `yt-dlp -f "bv*[height<=720]+ba/b[ext=mp4]/best[height<=720]" --merge-output-format mp4 -o <...> <URL>`
- Аудио MP3:
  - `yt-dlp -x --audio-format mp3 -o <...> <URL>`

После завершения проверяем итоговый файл: существует ли и не превышает ли `MAX_FILE_MB`.

## 10. Обработка ошибок (базовая)
- Неверная ссылка/неподдерживаемый URL: ответ «Похоже, это не ссылка на YouTube.»
- Приватные/ограниченные видео: «Видео недоступно для скачивания.»
- Таймаут/сеть: «Сервис временно недоступен, попробуйте позже.»
- Превышение размера: предложение выбрать «Аудио» или 360p.
- Внутренние ошибки: логируем подробно, пользователю — короткое объяснение.

## 11. Очистка файлов (опционально для MVP)
- Если `CLEANUP_TTL_HOURS > 0`: горутина с тикером раз в час удаляет файлы старше TTL из `DOWNLOAD_DIR`.
- Игнорировать ошибки удаления, логировать предупреждения.

## 12. Минимальные технические детали
- Язык: Go >= 1.25.
- Библиотека Telegram: `github.com/go-telegram-bot-api/telegram-bot-api/v5`.
- Зависимости: `yt-dlp` и `ffmpeg` установлены в систему и доступны в `$PATH` или по указанным путям.
- Логи: стандартный `log` или `zap` (для MVP достаточно `log`).

### Интерфейсы и типы (набросок)
- `type Job struct { ChatID int64; URL string; Kind string; Quality string; }`
- `queue.Enqueue(job Job)` — добавление задачи.
- `downloader.Run(ctx, job) (filePath string, sizeBytes int64, err error)` — запуск yt-dlp.
- `files.TooLarge(sizeBytes) bool` — проверка размера.
- `state.Put(token string, payload, ttl)` / `state.Get(token) (payload, ok)`.

## 13. Схема каталогов
```
cmd/
  bot/
    main.go
internal/
  telegram/
    bot.go         # обработка апдейтов и callback
  state/
    store.go       # in-memory TTL store
  queue/
    queue.go       # канал, воркеры
  downloader/
    yt_dlp.go      # сборка и запуск команд
  files/
    fs.go          # директория, размер, очистка
  config/
    config.go      # env, валидация
```

## 14. Установка и запуск
1) Установить `yt-dlp` и `ffmpeg`:
- macOS: `brew install yt-dlp ffmpeg`
- Ubuntu/Debian: `sudo apt-get install -y ffmpeg` и `pipx install yt-dlp` или `pip install yt-dlp`
- Windows: установить бинарники и прописать в PATH

2) Создать `.env` как в разделе 6.

3) Запустить локально: `go run cmd/bot/main.go`

## 15. Критерии готовности MVP
- Бот отвечает на `/start` и `/help`.
- На ссылку YouTube показывает кнопки 360p/720p/MP3.
- После выбора — запускает загрузку, по завершении отправляет файл или сообщает о превышении размера.
- Обрабатывает минимум 2 параллельные загрузки, очередь не падает.
- Логи понятные, ошибки не «пугают» пользователя.

## 16. Дорожная карта расширений (после MVP)
- Прокси-ротация, списки прокси из файла.
- Метрики Prometheus и графики Grafana.
- Хранение истории запросов и пользователей (БД), дедупликация.
- Веб-сервер для раздачи больших файлов и коротких публичных ссылок.
- Прогресс-уведомления, отмена загрузки, приоритеты.
- Квоты/лимиты на пользователя, антиспам.

---

Этот SPEC преднамеренно ограничен для быстрого старта. Реализацию начнём с каркаса по структуре каталогов, затем добавим обработку сообщений, очередь и минимальный раннер `yt-dlp`.
